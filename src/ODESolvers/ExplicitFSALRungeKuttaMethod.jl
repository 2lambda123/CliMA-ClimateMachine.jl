export ExplicitFSALRungeKutta
export ERK23BogackiShampine, ERK45DormandPrince, ERKFeagin14

using OffsetArrays
using CuArrays

mutable struct ExplicitFSALRungeKutta{T, RT, AT, ATA,ATB, Nstages, Nstages_sq} <:
               AbstractODESolver
    "time step"
    dt::RT
    "time"
    t::RT
    "rhs function"
    rhs!
    "Storage for the RHS evaluations"
    Rstages::NTuple{Nstages, AT}
    "Storage for the stages"
    Qstages::NTuple{Nstages, AT}
    order::Int
    embedded_order::Int
    "RK coefficient vector A (rhs scaling)"
    #RKA::SArray{NTuple{2, Nstages}, RT, 2, Nstages_sq}
    #"RK coefficient vector B (rhs add in scaling)"
    #RKB::SArray{Tuple{Nstages}, RT, 1, Nstages}
    #"RK coefficient vector B for the embedded scheme"
    #RKB_embedded::SArray{Tuple{Nstages}, RT, 1, Nstages}
    #"RK coefficient vector C (time scaling)"
    RKA::ATA
    #RKB::ATB
    RKB::SArray{Tuple{Nstages}, RT, 1, Nstages}
    RKB_embedded::SArray{Tuple{Nstages}, RT, 1, Nstages}
    "RK coefficient vector C (time scaling)"
    RKC::SArray{Tuple{Nstages}, RT, 1, Nstages}
    #RKC::ATB

    function ExplicitFSALRungeKutta(
        rhs!,
        order,
        embedded_order,
        RKA,
        RKB,
        RKB_embedded,
        RKC,
        Q::AT;
        dt = 0,
        t0 = 0,
    ) where {AT <: AbstractArray}
        T = eltype(Q)
        RT = real(T)
        Nstages = length(RKB)

        Rstages = ntuple(i -> similar(Q), Nstages)
        Qstages = ntuple(i -> similar(Q), Nstages)

        new{T, RT, AT, typeof(RKA),typeof(RKB), Nstages, Nstages^2}(
            RT(dt),
            RT(t0),
            rhs!,
            Rstages,
            Qstages,
            order,
            embedded_order,
            RKA,
            RKB,
            RKB_embedded,
            RKC,
        )
    end
end

embedded_order(erk::ExplicitFSALRungeKutta) = erk.embedded_order
updatedt!(erk::ExplicitFSALRungeKutta, dt) = erk.dt = dt
updatetime!(erk::ExplicitFSALRungeKutta, time) = (erk.t = time)

function ExplicitFSALRungeKutta(
    spacedisc::AbstractSpaceMethod,
    RKA,
    RKB,
    RKC,
    Q::AT;
    dt = 0,
    t0 = 0,
) where {AT <: AbstractArray}
    rhs! =
        (x...; increment) ->
            SpaceMethods.odefun!(spacedisc, x..., increment = increment)
    ExplicitFSALRungeKutta(
        rhs!,
        RKA,
        RKB,
        RKB_embedded,
        RKC,
        Q;
        dt = dt,
        t0 = t0,
    )
end

function dostep!(
    Qnp1,
    erk::ExplicitFSALRungeKutta,
    p_in,
    time,
    slow_δ = nothing,
    slow_rv_dQ = nothing,
    slow_scaling = nothing,
)
    p = p_in
    Qn = Qnp1
    error_estimate = nothing

    dt = erk.dt
    RKA, RKB, RKC = erk.RKA, erk.RKB, erk.RKC
    RKB_embedded = erk.RKB_embedded
    Nstages = length(RKB)
    rhs! = erk.rhs!
    Rstages, Qstages = erk.Rstages, erk.Qstages

    groupsize = 256

    for s in 1:Nstages
        event = Event(device(Qn))
        event = stage_update!(device(Qn), groupsize)(
            realview(Qn),
            realview.(Qstages),
            realview.(Rstages),
            RKA,
            dt,
            Val(s),
            slow_δ,
            slow_rv_dQ,
            ndrange = length(realview(Qn)),
            dependencies = (event,),
        )
        wait(device(Qn), event)
        rhs!(Rstages[s], Qstages[s], p, time + RKC[s] * dt, increment = false)
    end

    event = Event(device(Qn))
    event = solution_update!(device(Qn), groupsize)(
        realview(Qnp1),
        realview(Qn),
        realview(error_estimate),
        realview.(Qstages),
        realview.(Rstages),
        RKB,
        RKB_embedded,
        dt,
        Val(Nstages),
        slow_δ,
        slow_rv_dQ,
        slow_scaling,
        ndrange = length(realview(Qn)),
        dependencies = (event,),
    )
    wait(device(Qn), event)
end

@kernel function stage_update!(
    Q,
    Qstages,
    Rstages,
    RKA,
    dt,
    ::Val{is},
    slow_δ,
    slow_dQ,
) where {is}
    i = @index(Global, Linear)
    @inbounds begin
        if slow_δ !== nothing
            Rstages[is - 1][i] += slow_δ * slow_dQ[i]
        end
        Qstages_is_i = Q[i]
        @unroll for js in 1:(is - 1)
            Qstages_is_i += dt * RKA[is, js] * Rstages[js][i]
        end
        Qstages[is][i] = Qstages_is_i
    end
end

@kernel function solution_update!(
    Qnp1,
    Qn,
    error_estimate,
    Qstages,
    Rstages,
    RKB,
    RKB_embedded,
    dt,
    ::Val{Nstages},
    slow_δ,
    slow_dQ,
    slow_scaling,
) where {Nstages}
    i = @index(Global, Linear)
    @inbounds begin
        if slow_δ !== nothing
            Rstages[Nstages][i] += slow_δ * slow_dQ[i]
        end
        if slow_scaling !== nothing
            slow_dQ[i] *= slow_scaling
        end

        Qnp1[i] = Qn[i]
        @unroll for is in 1:Nstages
            Qnp1[i] += RKB[is] * dt * Rstages[is][i]
        end
    end
end

function ERK23BogackiShampine(
    F,
    Q::AT;
    dt = 0,
    t0 = 0,
) where {AT <: AbstractArray}
    #! format: off
    RKA = [0       0       0       0; 
           1 // 2  0       0       0;
           0       3 // 4  0       0;
           2 // 9  1 // 3  4 // 9  0]
    #! format: on

    RKB = [2 // 9, 1 // 3, 4 // 9, 0]
    RKB_embedded = [7 // 24, 1 // 4, 1 // 3, 1 // 8]
    RKC = [0, 1 // 2, 3 // 4, 1]

    ExplicitFSALRungeKutta(
        F,
        3,
        2,
        RKA,
        RKB,
        RKB_embedded,
        RKC,
        Q;
        dt = dt,
        t0 = t0,
    )
end

function ERK45DormandPrince(
    F,
    Q::AT;
    dt = 0,
    t0 = 0,
) where {AT <: AbstractArray}
    #! format: off
    RKA = [0              0              0               0            0              0        0; 
           1 // 5         0              0               0            0              0        0;
           3 // 40        9 // 40        0               0            0              0        0;
           44 // 45      -56 // 15       32 // 9         0            0              0        0;
           19372 // 6561 -25360 // 2187  64448 // 6561  -212 // 729   0              0        0;
           9017 // 3168  -355 // 33      46732 // 5247   49 // 176   -5103 // 18656  0        0;
           35//384        0              500 // 1113     125 // 192  -2187 // 6784   11 // 84 0]
    #! format: on

    RKB = [35 // 384, 0, 500 // 1113, 125 // 192, -2187 // 6784, 11 // 84, 0]
    RKB_embedded = [
        5179 // 57600,
        0,
        7571 // 16695,
        393 // 640,
        -92097 // 339200,
        187 // 2100,
        1 // 40,
    ]

    RKC = [0, 1 // 5, 3 // 10, 4 // 5, 8 // 9, 1, 1]

    ExplicitFSALRungeKutta(
        F,
        5,
        4,
        RKA,
        RKB,
        RKB_embedded,
        RKC,
        Q;
        dt = dt,
        t0 = t0,
    )
end

function ERKFeagin14(
    F,
    Q::AT;
    dt = 0,
    t0 = 0,
) where {AT <: AbstractArray}
    #! format: off
    T = eltype(Q)
    T2 = eltype(Q)
    Nstages = 35
    RKA = OffsetArray(zeros(T, Nstages, Nstages), -1, -1)
    RKB = zeros(T, Nstages)
    RKB_embedded = zeros(T, Nstages)
    RKC = OffsetArray(zeros(T, Nstages), -1)

  RKC[1  ]  = convert(T2,1//9)
  RKC[2    ]= convert(T2,5//9)
  RKC[3    ]= convert(T2,5//6)
  RKC[4    ]= convert(T2,1//3)
  RKC[5    ]= convert(T2,1)
  RKC[6    ]= convert(T2,big"0.669986979272772921764683785505998513938845229638460353285142")
  RKC[7    ]= convert(T2,big"0.297068384213818357389584716808219413223332094698915687379168")
  RKC[8    ]= convert(T2,8//11)
  RKC[9    ]= convert(T2,big"0.140152799042188765276187487966946717629806463082532936287323")
  RKC[10   ]= convert(T2,big"0.700701039770150737151099854830749337941407049265546408969222")
  RKC[11   ]= convert(T2,4//11)
  RKC[12   ]= convert(T2,big"0.263157894736842105263157894736842105263157894736842105263158")
  RKC[13   ]= convert(T2,big"0.0392172246650270859125196642501208648863714315266128052078483")
  RKC[14   ]= convert(T2,big"0.812917502928376762983393159278036506189612372617238550774312")
  RKC[15   ]= convert(T2,1//6)
  RKC[16   ]= convert(T2,9//10)
  RKC[17   ]= convert(T2,big"0.0641299257451966923312771193896682809481096651615083225402924")
  RKC[18   ]= convert(T2,big"0.204149909283428848927744634301023405027149505241333751628870")
  RKC[19   ]= convert(T2,big"0.395350391048760565615671369827324372352227297456659450554577")
  RKC[20   ]= convert(T2,big"0.604649608951239434384328630172675627647772702543340549445423")
  RKC[21   ]= convert(T2,big"0.795850090716571151072255365698976594972850494758666248371130")
  RKC[22   ]= convert(T2,big"0.935870074254803307668722880610331719051890334838491677459708")
  RKC[23   ]= convert(T2,1//6)
  RKC[24   ]= convert(T2,big"0.812917502928376762983393159278036506189612372617238550774312")
  RKC[25   ]= convert(T2,big"0.0392172246650270859125196642501208648863714315266128052078483")
  RKC[26   ]= convert(T2,4//11)
  RKC[27   ]= convert(T2,big"0.700701039770150737151099854830749337941407049265546408969222")
  RKC[28   ]= convert(T2,big"0.140152799042188765276187487966946717629806463082532936287323")
  RKC[29   ]= convert(T2,big"0.297068384213818357389584716808219413223332094698915687379168")
  RKC[30   ]= convert(T2,big"0.669986979272772921764683785505998513938845229638460353285142")
  RKC[31   ]= convert(T2,1//3)
  RKC[32   ]= convert(T2,5//9)
  RKC[33   ]= convert(T2,1//9)
  RKC[34   ]= convert(T2,1)

  RKB[1]  = convert(T,1//56)
  RKB[2]  = convert(T,3//512)
  RKB[3]  = convert(T,3//256)
  RKB[4]  = convert(T,0)
  RKB[5]  = convert(T,9//512)
  RKB[6]  = convert(T,0)
  RKB[7]  = convert(T,3//128)
  RKB[8]  = convert(T,15//512)
  RKB[9]  = convert(T,0)
  RKB[10] = convert(T,9//256)
  RKB[11] = convert(T,21//512)
  RKB[12] = convert(T,3//64)
  RKB[13] = convert(T,0)
  RKB[14] = convert(T,27//512)
  RKB[15] = convert(T,15//256)
  RKB[16] = convert(T,33//512)
  RKB[17] = convert(T,0)
  RKB[18] = convert(T,big"0.105352113571753019691496032887878162227673083080523884041670")
  RKB[19] = convert(T,big"0.170561346241752182382120338553874085887555487802790804737501")
  RKB[20] = convert(T,big"0.206229397329351940783526485701104894741914286259542454077972")
  RKB[21] = convert(T,big"0.206229397329351940783526485701104894741914286259542454077972")
  RKB[22] = convert(T,big"0.170561346241752182382120338553874085887555487802790804737501")
  RKB[23] = convert(T,big"0.105352113571753019691496032887878162227673083080523884041670")
  RKB[24] = convert(T,-33//512)
  RKB[25] = convert(T,-15//256)
  RKB[26] = convert(T,-27//512)
  RKB[27] = convert(T,-3//64)
  RKB[28] = convert(T,-21//512)
  RKB[29] = convert(T,-9//256)
  RKB[30] = convert(T,-15//512)
  RKB[31] = convert(T,-3//128)
  RKB[32] = convert(T,-9//512)
  RKB[33] = convert(T,-3//256)
  RKB[34] = convert(T,-3//512)
  RKB[35] = convert(T,1//56)

  RKA[1, 0] = convert(T,1//9)
  RKA[2, 0] = convert(T,-5//6)
  RKA[2, 1] = convert(T,25//18)
  RKA[3, 0] = convert(T,5//24)
  RKA[3, 2] = convert(T,5//8)
  RKA[4, 0] = convert(T,29//150)
  RKA[4, 2] = convert(T,11//50)
  RKA[4, 3] = convert(T,-2//25)
  RKA[5, 0] = convert(T,1//10)
  RKA[5, 3] = convert(T,2//5)
  RKA[5, 4] = convert(T,1//2)
  RKA[6, 0] = convert(T,big"0.103484561636679776672993546511910344499744798201971316606663")
  RKA[6, 3] = convert(T,big"0.122068887306407222589644082868962077139592714834162134741275")
  RKA[6, 4] = convert(T,big"0.482574490331246622475134780125688112865919023850168049679402")
  RKA[6, 5] = convert(T,big"-0.0381409600015606999730886240005620205664113072478411477421970")
  RKA[7, 0] = convert(T,big"0.124380526654094412881516420868799316268491466359671423163289")
  RKA[7, 4] = convert(T,big"0.226120282197584301422238662979202901196752320742633143965145")
  RKA[7, 5] = convert(T,big"0.0137885887618080880607695837016477814530969417491493385363543")
  RKA[7, 6] = convert(T,big"-0.0672210133996684449749399507414305856950086341525382182856200")
  RKA[8, 0] = convert(T,big"0.0936919065659673815530885456083005933866349695217750085655603")
  RKA[8, 5] = convert(T,big"-0.00613406843450510987229498995641664735620914507128858871007099")
  RKA[8, 6] = convert(T,big"0.216019825625503063708860097659866573490979433278117320188668")
  RKA[8, 7] = convert(T,big"0.423695063515761937337619073960976753205867469544123532683116")
  RKA[9, 0] = convert(T,big"0.0838479812409052664616968791372814085980533139224911131069335")
  RKA[9, 5] = convert(T,big"-0.0117949367100973814319755056031295775367961960590736150777613")
  RKA[9, 6] = convert(T,big"-0.247299020568812652339473838743194598325992840353340132697498")
  RKA[9, 7] = convert(T,big"0.0978080858367729012259313014081291665503740655476733940756599")
  RKA[9, 8] = convert(T,big"0.217590689243420631360008651767860318344168120024782176879989")
  RKA[10, 0] = convert(T,big"0.0615255359769428227954562389614314714333423969064821107453940")
  RKA[10, 5] = convert(T,big"0.00592232780324503308042990005798046524738389560444257136834990")
  RKA[10, 6] = convert(T,big"0.470326159963841112217224303205894113455362530746108825010848")
  RKA[10, 7] = convert(T,big"0.299688863848679000853981837096192399136831121671781279184194")
  RKA[10, 8] = convert(T,big"-0.247656877593994914689992276329810825853958069263947095548189")
  RKA[10, 9] = convert(T,big"0.110895029771437682893999851839061714522445173600678718208625")
  RKA[11, 0] = convert(T,big"0.0419700073362782579861792864787277787213483656543104611245994")
  RKA[11, 5] = convert(T,big"-0.00317987696266205093901912847692712407988609169703103952205634")
  RKA[11, 6] = convert(T,big"0.806397714906192077260821711520379506393543111567419750119748")
  RKA[11, 7] = convert(T,big"0.0975983126412388979093522850684288851314672048003054550357187")
  RKA[11, 8] = convert(T,big"0.778575578158398909027512446452927238999763460594181964958853")
  RKA[11, 9] = convert(T,big"0.204890423831599428189499202098105603312029235081420653574829")
  RKA[11, 10] = convert(T,big"-1.56261579627468188307070943950527825211462892236424360892806")
  RKA[12, 0] = convert(T,big"0.0437726782233730163574465242495339811688214967071614123256973")
  RKA[12, 8] = convert(T,big"0.00624365027520195208794358628580933625281631216903095917201250")
  RKA[12, 9] = convert(T,big"0.200043097109577314994435165469647856829066232218264969608768")
  RKA[12, 10] = convert(T,big"-0.00805328367804983036823857162048902911923392887337029314844206")
  RKA[12, 11] = convert(T,big"0.0211517528067396521915711903523399601316877825157550573051221")
  RKA[13, 0] = convert(T,big"0.0283499250363514563095023591920717312247137654896477097768495")
  RKA[13, 8] = convert(T,big"0.00249163204855817407538949148805995149459884653585417680098222")
  RKA[13, 9] = convert(T,big"0.0230138787854593149638399846373742768772087122638142234223658")
  RKA[13, 10] = convert(T,big"-0.00322155956692977098724476092467120878189463604760620461043308")
  RKA[13, 11] = convert(T,big"0.00988442549447664668946335414487885256040819982786014648129297")
  RKA[13, 12] = convert(T,big"-0.0213010771328887351384307642875927384886634565429572466632092")
  RKA[14, 0] = convert(T,big"0.343511894290243001049432234735147943083353174980701426268122")
  RKA[14, 8] = convert(T,big"0.210451912023627385609097011999010655788807405225626700040882")
  RKA[14, 09] = convert(T,big"1.03427452057230411936482926828825709938667999698324740166559")
  RKA[14, 10] = convert(T,big"0.00600303645864422487051240448206640574939078092406156945568306")
  RKA[14, 11] = convert(T,big"0.855938125099619537578012106002407728915062652616416005816477")
  RKA[14, 12] = convert(T,big"-0.977235005036766810872264852372525633013107656892839677696022")
  RKA[14, 13] = convert(T,big"-0.660026980479294694616225013856327693720573981219974874776419")
  RKA[15, 0] = convert(T,big"-0.0143574001672168069538206399935076366657755954378399880691949")
  RKA[15, 8] = convert(T,big"-0.0366253270049039970293685796848974791733119081733552207318285")
  RKA[15, 9] = convert(T,big"0.0350254975636213681976849406979846524346789082471103574920148")
  RKA[15, 10] = convert(T,big"0.0360946016362113508931786658758335239823689929864237671348749")
  RKA[15, 11] = convert(T,big"-0.0265219967553681106351595946834601923649627012457464284442911")
  RKA[15, 12] = convert(T,big"0.0445699011305698119638911537508839908104336323082226770910408")
  RKA[15, 13] = convert(T,big"0.124343093331358243286225595741786448038973408895106741855721")
  RKA[15, 14] = convert(T,big"0.00413829693239480694403512496204335960426192908674476033832967")
  RKA[16, 0] = convert(T,big"0.356032404425120290975609116398089176264106222379748802654822")
  RKA[16, 8] = convert(T,big"-0.450192758947562595966821779075956175110645100214763601190349")
  RKA[16, 9] = convert(T,big"0.430527907083710898626656292808782917793030154094709462877146")
  RKA[16, 10] = convert(T,big"0.511973029011022237668556960394071692077125787030651386389972")
  RKA[16, 11] = convert(T,big"0.908303638886404260390159124638110213997496214819904630546596")
  RKA[16, 12] = convert(T,big"-1.23921093371933931757372469151534028854413889248605726186520")
  RKA[16, 13] = convert(T,big"-0.649048661671761465141672348879062553905402831967191097656668")
  RKA[16, 14] = convert(T,big"0.251708904586819292210480529948970541404887852931447491219418")
  RKA[16, 15] = convert(T,big"0.779906470345586398810756795282334476023540593411550187024263")
  RKA[17, 0] = convert(T,big"0.0130935687406513066406881206418834980127470438213192487844956")
  RKA[17, 12] = convert(T,big"-0.0000932053067985113945908461962767108237858631509684667142124826")
  RKA[17, 13] = convert(T,big"0.0505374334262299359640090443138590726770942344716122381702746")
  RKA[17, 14] = convert(T,big"8.04470341944487979109579109610197797641311868930865361048975e-7")
  RKA[17, 15] = convert(T,big"0.000591726029494171190528755742777717259844340971924321528178248")
  RKA[17, 16] = convert(T,big"-4.01614722154557337064691684906375587732264247950093804676867e-7")
  RKA[18, 0] = convert(T,big"0.0207926484466053012541944544000765652167255206144373407979758")
  RKA[18, 12] = convert(T,big"0.000582695918800085915101902697837284108951406103029871570103075")
  RKA[18, 13] = convert(T,big"-0.00801700732358815939083342186525852746640558465919633524655451")
  RKA[18, 14] = convert(T,big"4.03847643847136940375170821743560570484117290330895506618968e-6")
  RKA[18, 15] = convert(T,big"0.0854609998055506144225056114567535602510114622033622491802597")
  RKA[18, 16] = convert(T,big"-2.04486480935804242706707569691004307904442837552677456232848e-6")
  RKA[18, 17] = convert(T,big"0.105328578824431893399799402979093997354240904235172843146582")
  RKA[19, 0] = convert(T,big"1.40153449795736021415446247355771306718486452917597731683689")
  RKA[19, 12] = convert(T,big"-0.230252000984221261616272410367415621261130298274455611733277")
  RKA[19, 13] = convert(T,big"-7.21106840466912905659582237106874247165856493509961561958267")
  RKA[19, 14] = convert(T,big"0.00372901560694836335236995327852132340217759566678662385552634")
  RKA[19, 15] = convert(T,big"-4.71415495727125020678778179392224757011323373221820091641216")
  RKA[19, 16] = convert(T,big"-0.00176367657545349242053841995032797673574903886695600132759652")
  RKA[19, 17] = convert(T,big"7.64130548038698765563029310880237651185173367813936997648198")
  RKA[19, 18] = convert(T,big"3.50602043659751834989896082949744710968212949893375368243588")
  RKA[20, 0] = convert(T,big"11.9514650694120686799372385830716401674473610826553517297976")
  RKA[20, 12] = convert(T,big"7.79480932108175968783516700231764388220284279598980948538579")
  RKA[20, 13] = convert(T,big"-56.4501393867325792523560991120904281440468100061340556540132")
  RKA[20, 14] = convert(T,big"0.0912376306930644901344530449290276645709607450403673704844997")
  RKA[20, 15] = convert(T,big"-12.7336279925434886201945524309199275038162717529918963305155")
  RKA[20, 16] = convert(T,big"-0.0396895921904719712313542810939736674712383070433147873009352")
  RKA[20, 17] = convert(T,big"54.4392141883570886996225765155307791861438378423305337073797")
  RKA[20, 18] = convert(T,big"-3.64411637921569236846406990361350645806721478409266709351203")
  RKA[20, 19] = convert(T,big"-0.804503249910509910899030787958579499315694913210787878260459")
  RKA[21, 0] = convert(T,big"-148.809426507100488427838868268647625561930612082148597076690")
  RKA[21, 12] = convert(T,big"-91.7295278291256484357935662402321623495228729036354276506427")
  RKA[21, 13] = convert(T,big"707.656144971598359834575719286335716154821128966649565194286")
  RKA[21, 14] = convert(T,big"-1.10563611857482440905296961311590930801338308942637769555540")
  RKA[21, 15] = convert(T,big"176.134591883811372587859898076055660406999516762301689616841")
  RKA[21, 16] = convert(T,big"0.491384824214880662268898345164454557416884631402764792538746")
  RKA[21, 17] = convert(T,big"-684.278000449814944358237535610895081956077167893600278300805")
  RKA[21, 18] = convert(T,big"27.9910604998398258984224332124380407446002518400668657974589")
  RKA[21, 19] = convert(T,big"13.1939710030282333443670964371153238435064159623744975073252")
  RKA[21, 20] = convert(T,big"1.25128781283980445450114974148056006317268830077396406361417")
  RKA[22, 0] = convert(T,big"-9.67307946948196763644126118433219395839951408571877262880482")
  RKA[22, 12] = convert(T,big"-4.46990150858505531443846227701960360497830681408751431146712")
  RKA[22, 13] = convert(T,big"45.5127128690952681968241950400052751178905907817398483534845")
  RKA[22, 14] = convert(T,big"-0.0713085086183826912791492024438246129930559805352394367050813")
  RKA[22, 15] = convert(T,big"11.2273614068412741582590624479939384207826800776794485051540")
  RKA[22, 16] = convert(T,big"0.126244376717622724516237912909138809361786889819105426371393")
  RKA[22, 17] = convert(T,big"-43.5439339549483313605810624907242107623814304467621407753424")
  RKA[22, 18] = convert(T,big"0.787174307543058978398792994996550902064546091443233850464377")
  RKA[22, 19] = convert(T,big"0.532264696744684215669300708603886690785395776821503851830821")
  RKA[22, 20] = convert(T,big"0.422422733996325326010225127471388772575086538809603346825334")
  RKA[22, 21] = convert(T,big"0.0859131249503067107308438031499859443441115056294154956487671")
  RKA[23, 0] = convert(T,big"-10.0664032447054702403396606900426891472202824757968765569183")
  RKA[23, 8] = convert(T,big"-0.0366253270049039970293685796848974791733119081733552207318285")
  RKA[23, 9] = convert(T,big"0.0350254975636213681976849406979846524346789082471103574920148")
  RKA[23, 10] = convert(T,big"0.0360946016362113508931786658758335239823689929864237671348749")
  RKA[23, 11] = convert(T,big"-0.0265219967553681106351595946834601923649627012457464284442911")
  RKA[23, 12] = convert(T,big"-6.27088972181464143590553149478871603839356122957396018530209")
  RKA[23, 13] = convert(T,big"48.2079237442562989090702103008195063923492593141636117832993")
  RKA[23, 14] = convert(T,big"-0.0694471689136165640882395180583732834557754169149088630301342")
  RKA[23, 15] = convert(T,big"12.6810690204850295698341370913609807066108483811412127009785")
  RKA[23, 16] = convert(T,big"0.0119671168968323754838161435501011294100927813964199613229864")
  RKA[23, 17] = convert(T,big"-46.7249764992482408003358268242662695593201321659795608950429")
  RKA[23, 18] = convert(T,big"1.33029613326626711314710039298216591399033511191227101321435")
  RKA[23, 19] = convert(T,big"1.00766787503398298353438903619926657771162717793661719708370")
  RKA[23, 20] = convert(T,big"0.0209512051933665091664122388475480702892770753864487241177616")
  RKA[23, 21] = convert(T,big"0.0210134706331264177317735424331396407424412188443757490871603")
  RKA[23, 22] = convert(T,big"0.00952196014417121794175101542454575907376360233658356240547761")
  RKA[24, 0] = convert(T,big"-409.478081677743708772589097409370357624424341606752069725341")
  RKA[24, 8] = convert(T,big"0.210451912023627385609097011999010655788807405225626700040882")
  RKA[24, 9] = convert(T,big"1.03427452057230411936482926828825709938667999698324740166559")
  RKA[24, 10] = convert(T,big"0.00600303645864422487051240448206640574939078092406156945568306")
  RKA[24, 11] = convert(T,big"0.855938125099619537578012106002407728915062652616416005816477")
  RKA[24, 12] = convert(T,big"-250.516998547447860492777657729316130386584050420782075966990")
  RKA[24, 13] = convert(T,big"1946.42466652388427766053750328264758595829850895761428240231")
  RKA[24, 14] = convert(T,big"-3.04503882102310365506105809086860882786950544097602101685174")
  RKA[24, 15] = convert(T,big"490.626379528281713521208265299168083841598542274061671576230")
  RKA[24, 16] = convert(T,big"1.56647589531270907115484067013597445739595615245966775329993")
  RKA[24, 17] = convert(T,big"-1881.97428994011173362217267377035870619215906638453056643641")
  RKA[24, 18] = convert(T,big"75.2592224724847175278837713643303149821620618914245864351135")
  RKA[24, 19] = convert(T,big"34.5734356980331067622434344736554689696728644793551014989002")
  RKA[24, 20] = convert(T,big"3.21147679440968961435417361847073755169022966748891627882572")
  RKA[24, 21] = convert(T,big"-0.460408041738414391307201404237058848867245095265382820823055")
  RKA[24, 22] = convert(T,big"-0.0870718339841810522431884137957986245724252047388936572215438")
  RKA[24, 23] = convert(T,big"-7.39351814158303067567016952195521063999185773249132944724553")
  RKA[25, 0] = convert(T,big"3.43347475853550878921093496257596781120623891072008459930197")
  RKA[25, 8] = convert(T,big"0.00249163204855817407538949148805995149459884653585417680098222")
  RKA[25, 9] = convert(T,big"0.0230138787854593149638399846373742768772087122638142234223658")
  RKA[25, 10] = convert(T,big"-0.00322155956692977098724476092467120878189463604760620461043308")
  RKA[25, 11] = convert(T,big"0.00988442549447664668946335414487885256040819982786014648129297")
  RKA[25, 12] = convert(T,big"2.16252799377922507788307841904757354045759225335732707916530")
  RKA[25, 13] = convert(T,big"-16.2699864546457421328065640660139489006987552040228852402716")
  RKA[25, 14] = convert(T,big"-0.128534502120524552843583417470935010538029037542654506231743")
  RKA[25, 15] = convert(T,big"-8.98915042666504253089307820833379330486511746063552853023189")
  RKA[25, 16] = convert(T,big"-0.00348595363232025333387080201851013650192401767250513765000963")
  RKA[25, 17] = convert(T,big"15.7936194113339807536235187388695574135853387025139738341334")
  RKA[25, 18] = convert(T,big"-0.574403330914095065628165482017335820148383663195675408024658")
  RKA[25, 19] = convert(T,big"-0.345602039021393296692722496608124982535237228827655306030152")
  RKA[25, 20] = convert(T,big"-0.00662241490206585091731619991383757781133067992707418687587487")
  RKA[25, 21] = convert(T,big"-0.00777788129242204164032546458607364309759347209626759111946150")
  RKA[25, 22] = convert(T,big"-0.00356084192402274913338827232697437364675240818791706587952939")
  RKA[25, 23] = convert(T,big"4.79282506449930799649797749629840189457296934139359048988332")
  RKA[25, 24] = convert(T,big"0.153725464873068577844576387402512082757034273069877432944621")
  RKA[26, 0] = convert(T,big"32.3038520871985442326994734440031535091364975047784630088983")
  RKA[26, 5] = convert(T,big"-0.00317987696266205093901912847692712407988609169703103952205634")
  RKA[26, 6] = convert(T,big"0.806397714906192077260821711520379506393543111567419750119748")
  RKA[26, 7] = convert(T,big"0.0975983126412388979093522850684288851314672048003054550357187")
  RKA[26, 8] = convert(T,big"0.778575578158398909027512446452927238999763460594181964958853")
  RKA[26, 9] = convert(T,big"0.204890423831599428189499202098105603312029235081420653574829")
  RKA[26, 10] = convert(T,big"-1.56261579627468188307070943950527825211462892236424360892806")
  RKA[26, 12] = convert(T,big"16.3429891882310570648504243973927174708753353504154550405647")
  RKA[26, 13] = convert(T,big"-154.544555293543621230730189631471036399316683669609116705323")
  RKA[26, 14] = convert(T,big"1.56971088703334872692034283417621761466263593582497085955201")
  RKA[26, 15] = convert(T,big"3.27685545087248131321429817269900731165522404974733504794135")
  RKA[26, 16] = convert(T,big"-0.0503489245193653176348040727199783626534081095691632396802451")
  RKA[26, 17] = convert(T,big"153.321151858041665070593767885914694011224363102594556731397")
  RKA[26, 18] = convert(T,big"7.17568186327720495846766484814784143567826308034865369443637")
  RKA[26, 19] = convert(T,big"-2.94036748675300481945917659896930989215320594380777597403592")
  RKA[26, 20] = convert(T,big"-0.0665845946076803144470749676022628870281920493197256887985612")
  RKA[26, 21] = convert(T,big"-0.0462346054990843661229248668562217261176966514016859284197145")
  RKA[26, 22] = convert(T,big"-0.0204198733585679401539388228617269778848579774821581777675337")
  RKA[26, 23] = convert(T,big"-53.3523106438735850515953441165998107974045090495791591218714")
  RKA[26, 24] = convert(T,big"-1.35548714715078654978732186705996404017554501614191325114947")
  RKA[26, 25] = convert(T,big"-1.57196275801232751882901735171459249177687219114442583461866")
  RKA[27, 0] = convert(T,big"-16.6451467486341512872031294403931758764560371130818978459405")
  RKA[27, 5] = convert(T,big"0.00592232780324503308042990005798046524738389560444257136834990")
  RKA[27, 6] = convert(T,big"0.470326159963841112217224303205894113455362530746108825010848")
  RKA[27, 7] = convert(T,big"0.299688863848679000853981837096192399136831121671781279184194")
  RKA[27, 8] = convert(T,big"-0.247656877593994914689992276329810825853958069263947095548189")
  RKA[27, 9] = convert(T,big"0.110895029771437682893999851839061714522445173600678718208625")
  RKA[27, 11] = convert(T,big"-0.491719043846229147070666628704194097678081907210673044988866")
  RKA[27, 12] = convert(T,big"-11.4743154427289496968389492564352536350842454130853175250727")
  RKA[27, 13] = convert(T,big"80.2593166576230272541702485886484400152793366623589989106256")
  RKA[27, 14] = convert(T,big"-0.384132303980042847625312526759029103746926841342088219165648")
  RKA[27, 15] = convert(T,big"7.28147667468107583471326950926136115767612581862877764249646")
  RKA[27, 16] = convert(T,big"-0.132699384612248379510571708176035274836827341616751884314074")
  RKA[27, 17] = convert(T,big"-81.0799832525730726674679289752255240006070716633632990308935")
  RKA[27, 18] = convert(T,big"-1.25037492835620639521768185656179119962253747492403205797494")
  RKA[27, 19] = convert(T,big"2.59263594969543681023776379504377324994226447359296887778718")
  RKA[27, 20] = convert(T,big"-0.301440298346404539830163997260526875264431537275641495291993")
  RKA[27, 21] = convert(T,big"0.221384460789832337451706451572773791695246839057318414301020")
  RKA[27, 22] = convert(T,big"0.0827577274771892931955989870974693152996276435429809890551210")
  RKA[27, 23] = convert(T,big"18.9960662040611520464672450037243263998175161412237156872211")
  RKA[27, 24] = convert(T,big"0.269231946409639685623468015128334167460051910348912845121977")
  RKA[27, 25] = convert(T,big"1.62674827447066537462989364929628933988125029284183680279020")
  RKA[27, 26] = convert(T,big"0.491719043846229147070666628704194097678081907210673044988866")
  RKA[28, 0] = convert(T,big"0.0838479812409052664616968791372814085980533139224911131069335")
  RKA[28, 5] = convert(T,big"-0.0117949367100973814319755056031295775367961960590736150777613")
  RKA[28, 6] = convert(T,big"-0.247299020568812652339473838743194598325992840353340132697498")
  RKA[28, 7] = convert(T,big"0.0978080858367729012259313014081291665503740655476733940756599")
  RKA[28, 8] = convert(T,big"0.217590689243420631360008651767860318344168120024782176879989")
  RKA[28, 10] = convert(T,big"0.137585606763325224865659632196787746647447222975084865975440")
  RKA[28, 11] = convert(T,big"0.0439870229715046685058790092341545026046103890294261359042581")
  RKA[28, 13] = convert(T,big"-0.513700813768193341957004456618630303738757363641964030086972")
  RKA[28, 14] = convert(T,big"0.826355691151315508644211308399153458701423158616168576922372")
  RKA[28, 15] = convert(T,big"25.7018139719811832625873882972519939511136556341960074626615")
  RKA[28, 23] = convert(T,big"-25.7018139719811832625873882972519939511136556341960074626615")
  RKA[28, 24] = convert(T,big"-0.826355691151315508644211308399153458701423158616168576922372")
  RKA[28, 25] = convert(T,big"0.513700813768193341957004456618630303738757363641964030086972")
  RKA[28, 26] = convert(T,big"-0.0439870229715046685058790092341545026046103890294261359042581")
  RKA[28, 27] = convert(T,big"-0.137585606763325224865659632196787746647447222975084865975440")
  RKA[29, 0] = convert(T,big"0.124380526654094412881516420868799316268491466359671423163289")
  RKA[29, 4] = convert(T,big"0.226120282197584301422238662979202901196752320742633143965145")
  RKA[29, 5] = convert(T,big"0.0137885887618080880607695837016477814530969417491493385363543")
  RKA[29, 6] = convert(T,big"-0.0672210133996684449749399507414305856950086341525382182856200")
  RKA[29, 9] = convert(T,big"-0.856238975085428354755349769879501772112121597411563802855067")
  RKA[29, 10] = convert(T,big"-1.96337522866858908928262850028093813988180440518267404553576")
  RKA[29, 11] = convert(T,big"-0.232332822724119401237246257308921847250108199230419994978218")
  RKA[29, 13] = convert(T,big"4.30660719086453349461668936876562947772432562053478092626764")
  RKA[29, 14] = convert(T,big"-2.92722963249465482659787911202390446687687394950633612630592")
  RKA[29, 15] = convert(T,big"-82.3131666397858944454492334105458707735761966428138676971041")
  RKA[29, 23] = convert(T,big"82.3131666397858944454492334105458707735761966428138676971041")
  RKA[29, 24] = convert(T,big"2.92722963249465482659787911202390446687687394950633612630592")
  RKA[29, 25] = convert(T,big"-4.30660719086453349461668936876562947772432562053478092626764")
  RKA[29, 26] = convert(T,big"0.232332822724119401237246257308921847250108199230419994978218")
  RKA[29, 27] = convert(T,big"1.96337522866858908928262850028093813988180440518267404553576")
  RKA[29, 28] = convert(T,big"0.856238975085428354755349769879501772112121597411563802855067")
  RKA[30, 0] = convert(T,big"0.103484561636679776672993546511910344499744798201971316606663")
  RKA[30, 3] = convert(T,big"0.122068887306407222589644082868962077139592714834162134741275")
  RKA[30, 4] = convert(T,big"0.482574490331246622475134780125688112865919023850168049679402")
  RKA[30, 5] = convert(T,big"-0.0381409600015606999730886240005620205664113072478411477421970")
  RKA[30, 7] = convert(T,big"-0.550499525310802324138388507020508177411414311000037561712836")
  RKA[30, 9] = convert(T,big"-0.711915811585189227887648262043794387578291882406745570495765")
  RKA[30, 10] = convert(T,big"-0.584129605671551340432988730158480872095335329645227595707052")
  RKA[30, 13] = convert(T,big"2.11046308125864932128717300046622750300375054278936987850718")
  RKA[30, 14] = convert(T,big"-0.0837494736739572135525742023001037992695260175335123517729291")
  RKA[30, 15] = convert(T,big"5.10021499072320914075295969043344113107545060862804249161191")
  RKA[30, 23] = convert(T,big"-5.10021499072320914075295969043344113107545060862804249161191")
  RKA[30, 24] = convert(T,big"0.0837494736739572135525742023001037992695260175335123517729291")
  RKA[30, 25] = convert(T,big"-2.11046308125864932128717300046622750300375054278936987850718")
  RKA[30, 27] = convert(T,big"0.584129605671551340432988730158480872095335329645227595707052")
  RKA[30, 28] = convert(T,big"0.711915811585189227887648262043794387578291882406745570495765")
  RKA[30, 29] = convert(T,big"0.550499525310802324138388507020508177411414311000037561712836")
  RKA[31, 0] = convert(T,29//150)
  RKA[31, 2] = convert(T,11//50)
  RKA[31, 3] = convert(T,-2//25)
  RKA[31, 6] = convert(T,big"0.109993425580724703919462404865068340845119058295846426463652")
  RKA[31, 7] = convert(T,big"-0.254297048076270161384068506997153122141835626976703920846242")
  RKA[31, 9] = convert(T,big"0.865570777116694254343770343821098281832847401233011859346737")
  RKA[31, 10] = convert(T,big"3.32416449114093083106799552786572018336860092936986407160200")
  RKA[31, 13] = convert(T,big"-12.0102223315977933882352385148661841260301942633996815127277")
  RKA[31, 14] = convert(T,big"0.476601466242493239430442776862061899602963782003580209476163")
  RKA[31, 15] = convert(T,big"-29.0243011221036390525802623213654099596251221332470910692353")
  RKA[31, 23] = convert(T,big"29.0243011221036390525802623213654099596251221332470910692353")
  RKA[31, 24] = convert(T,big"-0.476601466242493239430442776862061899602963782003580209476163")
  RKA[31, 25] = convert(T,big"12.0102223315977933882352385148661841260301942633996815127277")
  RKA[31, 27] = convert(T,big"-3.32416449114093083106799552786572018336860092936986407160200")
  RKA[31, 28] = convert(T,big"-0.865570777116694254343770343821098281832847401233011859346737")
  RKA[31, 29] = convert(T,big"0.254297048076270161384068506997153122141835626976703920846242")
  RKA[31, 30] = convert(T,big"-0.109993425580724703919462404865068340845119058295846426463652")
  RKA[32, 0] = convert(T,-5//6)
  RKA[32, 1] = convert(T,25//18)
  RKA[32, 4] = convert(T,-3//4)
  RKA[32, 6] = convert(T,big"-0.492529543718026304422682049114021320200214681580657784719074")
  RKA[32, 30] = convert(T,big"0.492529543718026304422682049114021320200214681580657784719074")
  RKA[32, 31] = convert(T,3//4)
  RKA[33, 0] = convert(T,1//9)
  RKA[33, 2] = convert(T,-2//9)
  RKA[33, 32] = convert(T,2//9)
  RKA[34, 0] = convert(T,big"0.285835140388971558796088842163836414852927537894596466840753")
  RKA[34, 1] = convert(T,7//24)
  RKA[34, 2] = convert(T,7//32)
  RKA[34, 4] = convert(T,21//128)
  RKA[34, 6] = convert(T,big"0.218194354945556658327188241581352107093288824322187941141516")
  RKA[34, 7] = convert(T,big"0.180392898478697766863635221946775437719620053641849228562435")
  RKA[34, 9] = convert(T,big"0.205713839404845018859120755122929542277570094982808905393991")
  RKA[34, 10] = convert(T,big"0.242715791581770239970282927959446515762745971386670541948576")
  RKA[34, 11] = convert(T,big"0.246465780813629305833609291181891407799228103869305705137021")
  RKA[34, 12] = convert(T,big"-3.44991940790890824979834154601622662060370460614931644223924")
  RKA[34, 13] = convert(T,big"0.228875562160036081760729060738458584294220372552740218459295")
  RKA[34, 14] = convert(T,big"0.283290599702151415321527419056733335978436595493855789831434")
  RKA[34, 15] = convert(T,big"3.21085125837766640960131490544236787005557320332238705967955")
  RKA[34, 16] = convert(T,big"-0.223538777364845699920233756214162507964125230083674032084065")
  RKA[34, 17] = convert(T,big"-0.707121157204419073518727286207487212130091231955206160635271")
  RKA[34, 18] = convert(T,big"3.21123345150287080408174729202856500893260034443022374267639")
  RKA[34, 19] = convert(T,big"1.40954348309669766030414474301123175769045945573548986335553")
  RKA[34, 20] = convert(T,big"-0.151362053443742613121602276742518111090963026203676055891793")
  RKA[34, 21] = convert(T,big"0.372350574527014276454724080214619984397121028202148298716575")
  RKA[34, 22] = convert(T,big"0.252978746406361336722199907762141285915775728129414319261111")
  RKA[34, 23] = convert(T,big"-3.21085125837766640960131490544236787005557320332238705967955")
  RKA[34, 24] = convert(T,big"-0.283290599702151415321527419056733335978436595493855789831434")
  RKA[34, 25] = convert(T,big"-0.228875562160036081760729060738458584294220372552740218459295")
  RKA[34, 26] = convert(T,big"-0.246465780813629305833609291181891407799228103869305705137021")
  RKA[34, 27] = convert(T,big"-0.242715791581770239970282927959446515762745971386670541948576")
  RKA[34, 28] = convert(T,big"-0.205713839404845018859120755122929542277570094982808905393991")
  RKA[34, 29] = convert(T,big"-0.180392898478697766863635221946775437719620053641849228562435")
  RKA[34, 30] = convert(T,big"-0.218194354945556658327188241581352107093288824322187941141516")
  RKA[34, 31] = convert(T,-21//128)
  RKA[34, 32] = convert(T,-7//32)
  RKA[34, 33] = convert(T,-7//24)

    ExplicitFSALRungeKutta(
        F,
        14,
        12,
        CuArray(parent(RKA)),
        RKB,
        RKB_embedded,
        parent(RKC),
        Q;
        dt = dt,
        t0 = t0,
    )
end
